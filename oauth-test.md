# OAuth2 Flows з Keycloak (OpenID Connect)

Цей документ містить опис і приклади всіх основних потоків авторизації OAuth2, протестованих із сервером авторизації Keycloak (OpenID Connect). Також наведено фрагмент опису для OpenAPI 3.

---

## Описано та протестовано:

- Authorization Code Flow
- Implicit Flow
- Resource Owner Password Credentials Flow (Password Grant)
- Client Credentials Flow

---

## OpenAPI 3.0: Опис securitySchemes

```yaml
components:
  securitySchemes:
    keycloakOAuth2:
      type: oauth2
      flows:
        authorizationCode:
          authorizationUrl: http://localhost:8080/realms/Sofa/protocol/openid-connect/auth
          tokenUrl: http://localhost:8080/realms/Sofa/protocol/openid-connect/token
          scopes:
            openid: OpenID Connect scope
        implicit:
          authorizationUrl: http://localhost:8080/realms/Sofa/protocol/openid-connect/auth
          scopes:
            openid: OpenID Connect scope
        password:
          tokenUrl: http://localhost:8080/realms/Sofa/protocol/openid-connect/token
          scopes:
            openid: OpenID Connect scope
        clientCredentials:
          tokenUrl: http://localhost:8080/realms/Sofa/protocol/openid-connect/token
          scopes:
            openid: OpenID Connect scope

security:
  - keycloakOAuth2: [openid]
```yaml

#Authorization Code Flow

---
Postman:
POST http://localhost:8080/realms/Sofa/protocol/openid-connect/token
Body (x-www-form-urlencoded):
client_id=nest-app
grant_type=authorization_code
code=code
redirect_uri=http://localhost:3000/callback
{
    "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJab012RHhzc2JYTHlFSmlEaThsQXBncDVtc2xxX2M2OGEycS16WndfWWNBIn0.eyJleHAiOjE3NDg1NjczNDUsImlhdCI6MTc0ODU2NzA0NSwiYXV0aF90aW1lIjoxNzQ4NTY2ODE4LCJqdGkiOiJiMTM1MjJjZi0zOGY1LTQ4YjctODIxMS1mNzUxMDg1ZjU5NGYiLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgwODAvcmVhbG1zL1NvZmEiLCJhdWQiOiJhY2NvdW50Iiwic3ViIjoiMTJhYjNlN2MtMWM1Mi00NzU0LWJkNWMtZmQzODY3YTcyNjRkIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoibmVzdC1hcHAiLCJzZXNzaW9uX3N0YXRlIjoiYWMyZWE2OGYtNDFkYy00ZDM4LTg2ZWQtMmUxYWFiZTYyNGYwIiwiYWNyIjoiMCIsImFsbG93ZWQtb3JpZ2lucyI6WyJodHRwOi8vbG9jYWxob3N0OjMwMDAiXSwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbIm9mZmxpbmVfYWNjZXNzIiwiZGVmYXVsdC1yb2xlcy1zb2ZhIiwidW1hX2F1dGhvcml6YXRpb24iLCJhcHAtdXNlciJdfSwicmVzb3VyY2VfYWNjZXNzIjp7ImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJtYW5hZ2UtYWNjb3VudC1saW5rcyIsInZpZXctcHJvZmlsZSJdfX0sInNjb3BlIjoib3BlbmlkIHByb2ZpbGUgZW1haWwiLCJzaWQiOiJhYzJlYTY4Zi00MWRjLTRkMzgtODZlZC0yZTFhYWJlNjI0ZjAiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsIm5hbWUiOiJVc2VyIE9uZSIsInByZWZlcnJlZF91c2VybmFtZSI6InVzZXIxIiwiZ2l2ZW5fbmFtZSI6IlVzZXIiLCJmYW1pbHlfbmFtZSI6Ik9uZSIsImVtYWlsIjoidXNlcjFAZXhhbXBsZS5jb20ifQ.jvQ2ieFKGOMgqUt5S9AHBJLRXIQqpNqIShgC7djozQqBNeGrnyJXLJivYUAzUYHhRJ0JfhxA2uhL_uroULSqpX-T2pEKoFnEtmagOlhZqFjhfQ-ezWC73Ck2TI0QC2xdANgm_sSQC82do1i2Kv028Pox6qoTcqAzHg3m9EOyOihCsP2vjN5FQetVLV7_S1iFWwlw4SrYRgHVBoZYf3ZXwuiz1za2mm5ozXaF7uA_1HefFh0ONu1uQIXbT2MeAMFfUK1B6iCyeJ1zcHgeMv4lf-LrbumwwNvxABWQaVP6wBn0MtLz-oYeli7sS__yVQ5Tj6fK9Q2-ICzO_cvcKX15PQ",
    "expires_in": 300,
    "refresh_expires_in": 1800,
    "refresh_token": "eyJhbGciOiJIUzUxMiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJmOGJhNjIxYi1kOWFhLTRlNTctOGFmZi1iM2Q5NjQzYmZjZTgifQ.eyJleHAiOjE3NDg1Njg4NDUsImlhdCI6MTc0ODU2NzA0NSwianRpIjoiNzMzYzdkMDktYTQ1Ny00ZjUzLTg0YjMtYzhlNTk3NzFhZjllIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9Tb2ZhIiwiYXVkIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9Tb2ZhIiwic3ViIjoiMTJhYjNlN2MtMWM1Mi00NzU0LWJkNWMtZmQzODY3YTcyNjRkIiwidHlwIjoiUmVmcmVzaCIsImF6cCI6Im5lc3QtYXBwIiwic2Vzc2lvbl9zdGF0ZSI6ImFjMmVhNjhmLTQxZGMtNGQzOC04NmVkLTJlMWFhYmU2MjRmMCIsInNjb3BlIjoib3BlbmlkIHByb2ZpbGUgZW1haWwiLCJzaWQiOiJhYzJlYTY4Zi00MWRjLTRkMzgtODZlZC0yZTFhYWJlNjI0ZjAifQ.9Lg1eUo08esNRgrwGYkqa1Y8UAyadiTe8eUEpbabDBCK52NUplUsvvq2aACda3IUeNYXAcClTAKoYqDO517X2g",
    "token_type": "Bearer",
    "id_token": "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJab012RHhzc2JYTHlFSmlEaThsQXBncDVtc2xxX2M2OGEycS16WndfWWNBIn0.eyJleHAiOjE3NDg1NjczNDUsImlhdCI6MTc0ODU2NzA0NSwiYXV0aF90aW1lIjoxNzQ4NTY2ODE4LCJqdGkiOiI0YTk4MmU1MC0wMjVmLTQ4ODEtODI4Yy1mZGRkMTVlNjM4MGMiLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgwODAvcmVhbG1zL1NvZmEiLCJhdWQiOiJuZXN0LWFwcCIsInN1YiI6IjEyYWIzZTdjLTFjNTItNDc1NC1iZDVjLWZkMzg2N2E3MjY0ZCIsInR5cCI6IklEIiwiYXpwIjoibmVzdC1hcHAiLCJzZXNzaW9uX3N0YXRlIjoiYWMyZWE2OGYtNDFkYy00ZDM4LTg2ZWQtMmUxYWFiZTYyNGYwIiwiYXRfaGFzaCI6Im1sQThjT1JaUlZiVmZQbzBSVmZvWEEiLCJhY3IiOiIwIiwic2lkIjoiYWMyZWE2OGYtNDFkYy00ZDM4LTg2ZWQtMmUxYWFiZTYyNGYwIiwiZW1haWxfdmVyaWZpZWQiOmZhbHNlLCJuYW1lIjoiVXNlciBPbmUiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJ1c2VyMSIsImdpdmVuX25hbWUiOiJVc2VyIiwiZmFtaWx5X25hbWUiOiJPbmUiLCJlbWFpbCI6InVzZXIxQGV4YW1wbGUuY29tIn0.kzngNs4kkr-oNB9lInzVCgv75XfwvteeXOP80jQAFwXAsOJu_fVg0HClJoyyU7TbD9T1r7_laHHjIEvms-McXQdBFw0_jHon9pJmcGjxnUdtNeebFCa_soQYm0Ja3YsBNRjZrVHJ-JPHgCaZ058lG6LDYN0Hw0yNVbdWeMONTaAlJ-Pzhj6C02bKmT8u9M9i3SzfLglYTIttVfcjgwHWQPdGP0C9vSDmUvr8J6myw8sBp5XUFK70qaWMe1Iq2ajR_OO7xL_7bPIU1hs48bZxCtZfl_Y9xJGDRoTVaEhQBE4TrZBAArg4Kbz5RNcB3VXYneraCx44rGbDmP4jXPzD0g",
    "not-before-policy": 0,
    "session_state": "ac2ea68f-41dc-4d38-86ed-2e1aabe624f0",
    "scope": "openid profile email"
}
---

#Implicit Flow

---
http://localhost:8080/realms/Sofa/protocol/openid-connect/auth?client_id=nest-app&response_type=token&scope=openid&redirect_uri=http://localhost:3000/callback
access_token=eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJab012RHhzc2JYTHlFSmlEaThsQXBncDVtc2xxX2M2OGEycS16WndfWWNBIn0.eyJleHAiOjE3NDg1NjgwNTEsImlhdCI6MTc0ODU2NzE1MSwiYXV0aF90aW1lIjoxNzQ4NTY2ODE4LCJqdGkiOiIwZDViMjE4My1jOTAyLTQwMTUtOTdmZC1mZDU1YWM5ZmY3NWUiLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgwODAvcmVhbG1zL1NvZmEiLCJhdWQiOiJhY2NvdW50Iiwic3ViIjoiMTJhYjNlN2MtMWM1Mi00NzU0LWJkNWMtZmQzODY3YTcyNjRkIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoibmVzdC1hcHAiLCJzZXNzaW9uX3N0YXRlIjoiYWMyZWE2OGYtNDFkYy00ZDM4LTg2ZWQtMmUxYWFiZTYyNGYwIiwiYWNyIjoiMCIsImFsbG93ZWQtb3JpZ2lucyI6WyJodHRwOi8vbG9jYWxob3N0OjMwMDAiXSwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbIm9mZmxpbmVfYWNjZXNzIiwiZGVmYXVsdC1yb2xlcy1zb2ZhIiwidW1hX2F1dGhvcml6YXRpb24iLCJhcHAtdXNlciJdfSwicmVzb3VyY2VfYWNjZXNzIjp7ImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJtYW5hZ2UtYWNjb3VudC1saW5rcyIsInZpZXctcHJvZmlsZSJdfX0sInNjb3BlIjoib3BlbmlkIHByb2ZpbGUgZW1haWwiLCJzaWQiOiJhYzJlYTY4Zi00MWRjLTRkMzgtODZlZC0yZTFhYWJlNjI0ZjAiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsIm5hbWUiOiJVc2VyIE9uZSIsInByZWZlcnJlZF91c2VybmFtZSI6InVzZXIxIiwiZ2l2ZW5fbmFtZSI6IlVzZXIiLCJmYW1pbHlfbmFtZSI6Ik9uZSIsImVtYWlsIjoidXNlcjFAZXhhbXBsZS5jb20ifQ.QphAC-YUJuJeLeXxrD5_s_P5l1L8YGTBXt5WOzaRQR1Pq2J-M0G9QH25M3DqD0uk1DyG8UffVRYHfiYrAhemOkiayaQ9L4t7SYkgfE26YHIv0e9bXddEKxPMe0DLNi5QcV5FIi1P4J3e_1FcHlwSei5BXFQm4YuPsQec-qi5xgOTpih538ckW_EIyHNhnQjJhhsf4W54vQZabhw5gvvnXA3__N3fA5xcD1DVtsvQ15YDpSlVaqOGVawAty5JhtJz-4vTNnBh4duuZnZR5tOJLX94gWvj3VaIrGXQrMz9TsDaS5UJ7d6wTGr8M8dP7OK7KkuNtI8u_zsfoOiM8FoY3Q&token_type=Bearer&expires_in=900
---

#Password Credentials Flow

---
Postman
POST http://localhost:8080/realms/Sofa/protocol/openid-connect/token
Body (x-www-form-urlencoded):
client_id=nest-app
grant_type=password
username=User1
password=123456
{
    "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJab012RHhzc2JYTHlFSmlEaThsQXBncDVtc2xxX2M2OGEycS16WndfWWNBIn0.eyJleHAiOjE3NDg1Njc1ODMsImlhdCI6MTc0ODU2NzI4MywianRpIjoiZTNkNGYxMjQtZmZlYy00ODBiLTg0ZjctZmNlNjI2OTBiYzQzIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9Tb2ZhIiwiYXVkIjoiYWNjb3VudCIsInN1YiI6IjEyYWIzZTdjLTFjNTItNDc1NC1iZDVjLWZkMzg2N2E3MjY0ZCIsInR5cCI6IkJlYXJlciIsImF6cCI6Im5lc3QtYXBwIiwic2Vzc2lvbl9zdGF0ZSI6IjdjMmRiZThlLThjZTYtNGZhNy1iYWQzLWZjNjA1YTMzZDljNSIsImFjciI6IjEiLCJhbGxvd2VkLW9yaWdpbnMiOlsiaHR0cDovL2xvY2FsaG9zdDozMDAwIl0sInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJvZmZsaW5lX2FjY2VzcyIsImRlZmF1bHQtcm9sZXMtc29mYSIsInVtYV9hdXRob3JpemF0aW9uIiwiYXBwLXVzZXIiXX0sInJlc291cmNlX2FjY2VzcyI6eyJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6InByb2ZpbGUgZW1haWwiLCJzaWQiOiI3YzJkYmU4ZS04Y2U2LTRmYTctYmFkMy1mYzYwNWEzM2Q5YzUiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsIm5hbWUiOiJVc2VyIE9uZSIsInByZWZlcnJlZF91c2VybmFtZSI6InVzZXIxIiwiZ2l2ZW5fbmFtZSI6IlVzZXIiLCJmYW1pbHlfbmFtZSI6Ik9uZSIsImVtYWlsIjoidXNlcjFAZXhhbXBsZS5jb20ifQ.mt1WWsKwqNF31eDRdiC217hLjCaG0_DaSYz5hWuVmsQ8ZX2i0ja18KeRDQFqZ3lW6LLkFlP1onMV3xghaUdkDtGt7KJrSAWZykoJRymdHQo9Z_JmVIcG-eO5rO9sBPUdPhIlUC_ixtXXtNg7116a7Pz96TjveHjzi17N8026WfSL2ztzgASzZrLuSQomFUpmsPnJMp9D3TEnrcI92-NPboRij6aR3aUA_cC446XO-dVaAk0rmDtRDX5XBQDoeuHiYc_C-K3QoUsoOrp5x-3_fEnjtk033UFSl8aUpFJmfIV0JtXgBla5al32pHd8Xg5GwIiczr8meYvnPPe2S_Is-Q",
    "expires_in": 300,
    "refresh_expires_in": 1800,
    "refresh_token": "eyJhbGciOiJIUzUxMiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJmOGJhNjIxYi1kOWFhLTRlNTctOGFmZi1iM2Q5NjQzYmZjZTgifQ.eyJleHAiOjE3NDg1NjkwODMsImlhdCI6MTc0ODU2NzI4MywianRpIjoiZWU5MDY5NzItOTc4Zi00NGIzLWE3NDMtM2RiMzg1OTI0ZWI5IiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9Tb2ZhIiwiYXVkIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9Tb2ZhIiwic3ViIjoiMTJhYjNlN2MtMWM1Mi00NzU0LWJkNWMtZmQzODY3YTcyNjRkIiwidHlwIjoiUmVmcmVzaCIsImF6cCI6Im5lc3QtYXBwIiwic2Vzc2lvbl9zdGF0ZSI6IjdjMmRiZThlLThjZTYtNGZhNy1iYWQzLWZjNjA1YTMzZDljNSIsInNjb3BlIjoicHJvZmlsZSBlbWFpbCIsInNpZCI6IjdjMmRiZThlLThjZTYtNGZhNy1iYWQzLWZjNjA1YTMzZDljNSJ9.b2Vmwb6RrbdIhTB3vdo_roDNkzwem-R6oCTB1sBlyQ4W-jmbItItSibAUxoMf82XVQdi6hDgmOoaY9-sfEg6ew",
    "token_type": "Bearer",
    "not-before-policy": 0,
    "session_state": "7c2dbe8e-8ce6-4fa7-bad3-fc605a33d9c5",
    "scope": "profile email"
}
---

#Client Credentials Flow

---
Postman
POST http://localhost:8080/realms/Sofa/protocol/openid-connect/token
Body (x-www-form-urlencoded):
client_id=nest-app
client_secret=secret (якщо є, для confidential client)
grant_type=client_credentials
{
    "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJab012RHhzc2JYTHlFSmlEaThsQXBncDVtc2xxX2M2OGEycS16WndfWWNBIn0.eyJleHAiOjE3NDg1Njc2NzksImlhdCI6MTc0ODU2NzM3OSwianRpIjoiODY3ODRhNGItNzI5Yi00MmRlLWFjZjItOGRlMTRhZGQxNWQzIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9Tb2ZhIiwiYXVkIjoiYWNjb3VudCIsInN1YiI6ImU3Y2I5ZDQ1LTU5MmEtNGIzNC04NGVjLTZiMGNkYjA5OWMzZSIsInR5cCI6IkJlYXJlciIsImF6cCI6Im5lc3QtYXBwIiwiYWNyIjoiMSIsImFsbG93ZWQtb3JpZ2lucyI6WyJodHRwOi8vbG9jYWxob3N0OjMwMDAiXSwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbIm9mZmxpbmVfYWNjZXNzIiwiZGVmYXVsdC1yb2xlcy1zb2ZhIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6InByb2ZpbGUgZW1haWwiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsImNsaWVudEhvc3QiOiIxNzIuMTcuMC4xIiwicHJlZmVycmVkX3VzZXJuYW1lIjoic2VydmljZS1hY2NvdW50LW5lc3QtYXBwIiwiY2xpZW50QWRkcmVzcyI6IjE3Mi4xNy4wLjEiLCJjbGllbnRfaWQiOiJuZXN0LWFwcCJ9.vJ6_15q1xjKDZmQVKeYxwhAwpBb-Ow7hQkI_pnVCy84GrDxoowRITIrP-03Lce5sQpaLfqh0fKzQXbg3NALNoYlxD-f7NU3pBiIPr7SFRyjCIaWbK5yWn_fox1B_Q-vaWFc4kZOAoYbzScF8DsSyg2ylrspG7QTUtcsQoF3V3xD14Ufac79_QEzWw1EehA9iWjzwe0r-DroRkbBpNxj6ymVKL0zI87XMuz-F89flgB7IxHQBDeRutwwLDecTPbgXiHzkn7fIk6aG-Z6Kh1y3LBhnrEjTr0aIPutBJFI_dcm6dDR-ydhjhjPL-3s8kzcE2ELtBOXs9VozKSsPT5M2ew",
    "expires_in": 300,
    "refresh_expires_in": 0,
    "token_type": "Bearer",
    "not-before-policy": 0,
    "scope": "profile email"
}
---
